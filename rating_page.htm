<html>
  <head>
    <style>
      textarea {
        vertical-align: top;
      }
    </style>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="bootstrap.css" />
    <link rel="stylesheet" href="styles.css" />
    <!-- timer css
    <link rel="stylesheet" href="./progressor.css" /> -->

    <!--  Stepper分頁-->
    <meta charset="utf-8" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bs-stepper@1.7.0/dist/css/bs-stepper.min.css"
    />
  </head>

  <body bgcolor="#ccccff">
    <nav
      class="navbar navbar-default fixed-top navbar-expand-lg navbar-light bg-light"
    >
      <div class="container">
        <!-- diff : .container 包住 nav -->

        <!-- .navbar-brand 左上LOGO位置 -->
        <a class="navbar-brand" href="new_index.php">
          <img
            src="logo.svg"
            alt=""
            width="40"
            height="40"
            class="d-inline-block align-text-top"
          />
          <span class="h3 mx-1"><!--網站標題--></span>
        </a>
        <!-- .navbar-toggler 漢堡式選單按鈕 -->
        <button
          class="navbar-toggler"
          type="button"
          data-toggle="collapse"
          data-target="#navbarSupportedContent"
          aria-controls="navbarSupportedContent"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <!-- .navbar-toggler-icon 漢堡式選單Icon -->
          <span class="navbar-toggler-icon"></span>
        </button>

        <!-- .collapse.navbar-collapse 用於外層中斷點群組和隱藏導覽列內容 -->
        <!-- 選單項目&漢堡式折疊選單 -->
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav mr-auto">
            <!-- active表示當前頁面 -->
            <!--li class="nav-item active">
                <a class="nav-link" href="#">首頁<span class="sr-only">(current)</span></a>
                </li-->
          </ul>

          <ul class="navbar-nav me-auto mb-2 mb-lg-0 navbar-right">
            <li class="nav-item">
              <a class="nav-link" style="pointer-events: none"
                ><strong> Hi !</strong></a
              >
            </li>

            <li class="nav-item">
              <!--a class="nav-link" href="0_login.php">註冊/登入</a-->
              <a class="nav-link" href="{:php_guide}">{:check_login}</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <script src="https://cdn.jsdelivr.net/npm/bs-stepper@1.7.0/dist/js/bs-stepper.min.js"></script>

    <!--Pop Window-->
    <script
      src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
      integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"
      integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
      integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
      crossorigin="anonymous"
    ></script>

    <script>
      var stepperElem = document.querySelector(".bs-stepper");
      var stepper = new Stepper(stepperElem);
      var done = false;
      var currStep = 1;
      history.pushState(currStep, "");
      //切換到步驟前觸發，呼叫e.preventDefault()可阻止切換
      stepperElem.addEventListener("show.bs-stepper", function (e) {
        if (done) {
          //若程序完成，不再切換
          e.preventDefault();
          return;
        }
      });
      //切換到步驟後觸發，e.detail.indexStep為目前步驟序號(從0開始)
      stepperElem.addEventListener("shown.bs-stepper", function (e) {
        var idx = e.detail.indexStep + 1;
        currStep = idx;
        //pushState()記下歷程以支援瀏覽器回上頁功能
        history.pushState(idx, "");
      });
      //瀏覽器上一頁下一頁觸發
      window.onpopstate = function (e) {
        if (e.state && e.state != currStep) stepper.to(e.state);
      };
      //模擬送出表單，註記已完成，不再允許切換步驟
      function simulateSubmit() {
        stepper.next();
        done = true;
      }

      //Pop up Window
      $("#myModal").on("shown.bs.modal", function () {
        var timestamp = get_timestamp();
        console.log('- Display Popup - ', timestamp)
        $("#myInput").trigger("focus");
      });

      var myModal = new bootstrap.Modal(document.getElementById('exampleModalCenter'), {
        keyboard: false
      });
    </script>

    <!--  監聽評論字數輸入-->
    <script>
      let count = 0;
      function checkLength(which) {
        //Review_Negative
        var maxChars = 100; //輸入上限為100個字
        if (which.value.length > maxChars)
          which.value = which.value.substring(0, maxChars);
        //var curr = maxChars - which.value.length;
        var curr = which.value.length;
        document.getElementById("chLeft").innerHTML = curr.toString();
      }

      function checkLength_P(which) {
        //Review_Positive
        var maxChars = 100; //輸入上限為100個字
        if (which.value.length > maxChars)
          which.value = which.value.substring(0, maxChars);
        //var curr = maxChars - which.value.length;
        var curr = which.value.length;
        document.getElementById("chLeft_P").innerHTML = curr.toString();
      }

      /*function getSequence(event){
        if(event.srcElement.id.search('firstPositive') != -1 || event.srcElement.id.search('secondNegative') != -1){
          return 'Sequence A';
        }
        return 'Sequence B';
      }*/
      
      //正負評論順序
      function getSequence(event){
        switch (unique_rand){
          case "1":
          case "2":
          case "3":
          case "4":   
            return 'Sequence A'; //先正面評論 再負面
            break;
          default:
            //return unique_rand;
            return 'Sequence B'; //先負面評論 再正面
        }    
      }
      //Condition順序
      function getCondition(event){
        switch (unique_rand){
          case "1":
          case "7":
            return 'C1'; //Have experience & with confirmation dialog 
            break;
          case "2":
          case "6":
            return 'C2'; //Have experience & without confirmation dialog 
            break;
          case "4":
          case "5":   
            return 'C3'; //Do not have experience & with confirmation dialog
            break;
          default:
            return 'C4'; //No exp & without dialog
        }    
      }

      function getPhase(event){
        if(event.srcElement.id.search('revise') != -1){
          return'Phase2';
        }
        return 'Phase1';
      }

      function getTypeTextarea(event){
        if(event.srcElement.id.search('Positive') != -1){
          return 'Negative';
        }
        return 'Positive';
      }
      
      var timestamp = get_timestamp();
      var condition = getCondition(event);
      function getElementIdTimestamp(event){
        var phase = getPhase(event);
        var sequence = getSequence(event);
        if(event.type === 'focus') {
          console.log('-', phase, '- Focus Textarea -', timestamp, '-', sequence,'-', condition);
        } else {
          console.log('-', phase,'-', event.srcElement.id, '-', timestamp,'-', condition);
        }
      }

      function getKeydown(event){
        var phase = getPhase(event);
        var sequence = getSequence(event);
        var key = event.key;
        if(key === 'Backspace' || key === 'Delete'){
          count++;
          console.log('-', phase, ' -Enter Key:', key, '-',timestamp, '-', sequence, '- - # of backspace/delete:', count);
        } else {
          console.log('-', phase, '- Enter Key:', key, '-',timestamp, '-', sequence,'-', condition);
        }
      }
  
      function moveNextStep(event){
        var timestamp = get_timestamp();
        console.log('-', timestamp, '-', event.srcElement.id);
        return stepper.next();
      };

      /* 定時進入下一階段  */
      var timesRun = 0;
      var timestamp = get_timestamp();
      function phase1_timer(){   //Phase_1 Review 的定時: 3min + 3s + 3min +3s
        timesRun += 1;
        switch(timesRun){  
          case 5:  //第一次填寫完評論
            stepper.next();
            console.log("- Phase1 - Enter 「感謝您填寫評論」 Page (First review)-", timestamp,'-', condition);
            break;
          case 8:  //結束第一次提醒
            stepper.next();
            console.log("- Phase1 - Enter Review Page -", timestamp,'-', condition);
            // console.log("- Phase1 - 第一次提醒 -", timestamp);
            break;
          case 13: //第二次填寫完評論
            stepper.next();
            console.log("- Phase1 - Enter 「感謝您填寫評論」 Page (Second review)-", timestamp);
            //clearInterval(interval); // 清除定时器  
            break;
        }   
      }

      function phase2_timer(){   //Phase_2 Reeview 的定時: 2min + 3s + 2min +3s
        timesRun += 1;
        switch(timesRun){  
          case 5:  //第一次填寫完評論
            console.log("- Phase2 - Start Revise Page - ", timestamp,'-', condition);
            stepper.next();
            console.log("- Phase2 - Enter 「感謝您填寫評論」 Page (First review)-", timestamp,'-', condition);
            break;
          case 8:  //結束第一次提醒
            stepper.next();
            console.log("- Phase2 - Enter Review Page -", timestamp,'-', condition);
            break;
          case 13: //第二次填寫完評論
            stepper.next();
            console.log("- Phase2 - Enter 「感謝您填寫評論」 Page (Second review)-", timestamp,'-', condition);
            break;
          case 16: //結束第二次提醒 跳到自評問卷
            stepper.next();
            document.getElementById("ReviewForm").submit();
            console.log("- Phase2 - End of Phase2 -", timestamp,'-', condition);
            //clearInterval(interval); // 清除定时器  
            break;  
        }   
      }
      //var interval = setInterval(phase2_timer, 1000); 

      //Loading畫面 結束
      function submit_timer_phase1(){   
        document.getElementById("ReviewForm").submit();
        console.log("- Phase1 - End of Loading -", timestamp,'-',condition);
      }

      function getPopupDisplayTimestamp(){
        console.log("- Phase1 - Popup display -", timestamp,'-', condition);
      }

      function get_timestamp(){
        const date = new Date();
        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        const day = date.getDate();
        const hour = date.getHours();
        const min = date.getMinutes();
        const sec = date.getSeconds();
        const millisec = date.getMilliseconds();
        const dates = [year, month, day].join("/");
        const seconds = [hour, min, sec, millisec].join(":");
        const timestamp = [dates, seconds].join(" - ");
        return timestamp;
      }

      //提交Questionnaire
      function submit_timer_question(){   
        document.getElementById("ReviewForm").submit();
        console.log("- End Trial - Submit Questionnaire -", timestamp,'-', condition);
      }

      //開始撰寫評論
      function start_timer(){   
        document.getElementById("StartReview").submit();
        console.log("- Phase1 - ===Start Trial=== - ", timestamp);
      }


      //點擊Pop up MSG的繼續(button)後，出現loading page，(15-reaction)秒後自動跳到 Phase_2
      function stepFour_PopUp(){
        console.log("- Phase 1 - Click Popup Continue Button - ", timestamp,'-', condition);
        myModal.hide(); //關閉Modal 
        loader.style.display = "block"; //顯示loader
        //window.setTimeout("submit_timer_phase1()",5000); //5秒後submit，進入Phase_2
      };
      
      //Phase_1的提醒結束後，出現loading page
      function stepFour(){
        loader.style.display = "block";
        console.log("- Phase1 - Enter Loading Page - " ,timestamp,'-', condition);
        window.setTimeout("submit_timer_phase1()", 5000); //15秒後submit，進入Phase_2
      };
    </script>


    <!--insert jquery-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.js"></script>
    <!-- timer JS-->
    <script>
      var fullTime = 180;
      var warn = 20;
      var almost = 10;

      var currTime = fullTime;

      var timer = setInterval(function () {
        --currTime;

        // Clear interval if time is up:
        if (!currTime) window.clearInterval(timer);

        //separate min and sec
        var T_sec = Math.floor(currTime % 60);
        var T_min = Math.floor(currTime / 60);

        // Prepend 0 if single-digit number:
        //var txt = currTime.toString().length === 1 ? "0" + currTime : currTime;
        var txt_s = T_sec.toString().length === 1 ? "0" + T_sec : T_sec;
        var txt_m = T_min.toString().length === 1 ? "0" + T_min : T_min;

        // Set time to show to user:
        //$("#sec").text(txt);
        $("#sec").text(txt_s);
        $("#min").text(txt_m);

        // Decrease the bar width:
        var w = (currTime / fullTime) * 100;
        $(".timer-bar").css({ width: w + "%" });

        // Manipulate bar according to the value:
        if (currTime === warn) $(".timer-bar").addClass("timer-warn");
        if (currTime === almost) $(".timer-bar").addClass("timer-almost");
      }, 1000);
    </script>

  </body>
</html>
